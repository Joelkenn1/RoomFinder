<!DOCTYPE html>
<html>
<head>
  <title>Indoor AR Navigation</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    #arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      transform-origin: center;
      transition: transform 0.2s ease;
      z-index: 10;
    }
    #arrivalPrompt {
      display: none;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 20;
    }
    #progressPrompt {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 16px;
      z-index: 20;
    }
    #flipButton {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 20;
      padding: 10px 15px;
      font-size: 14px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #flipButton:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <video id="camera" autoplay playsinline></video>
  <img id="arrow" src="arrow.png" alt="Arrow">
  <div id="arrivalPrompt">You've arrived at your classroom!</div>
  <div id="progressPrompt">Calculating progress...</div>
  <button id="flipButton" onclick="flipCamera()">Flip Camera</button>

<script>
  const arrow = document.getElementById('arrow');
  const arrivalPrompt = document.getElementById('arrivalPrompt');
  const progressPrompt = document.getElementById('progressPrompt');
  const camera = document.getElementById('camera');

  const maps = {
    MainCampus: {
      EngineeringHall: {
        Room101: { x: 10, y: 5 },
        Room102: { x: 12, y: 5 },
        Room201: { x: 10, y: 10 },
        Room202: { x: 12, y: 10 },
        Lobby: { x: 5, y: 2 },
        Entrance: { x: 0, y: 0 }
      },
      Library: {
        Room301: { x: 8, y: 3 },
        Room302: { x: 9, y: 6 },
        Entrance: { x: 0, y: 0 }
      }
    },
    ArmstrongCampus: {
      ScienceCenter: {
        Room401: { x: 15, y: 10 },
        Room402: { x: 17, y: 12 },
        Entrance: { x: 0, y: 0 }
      }
    }
  };

  const params = new URLSearchParams(window.location.search);
  const campus = params.get("campus");
  const building = params.get("building");
  const startRoom = params.get("start");
  const destRoom = params.get("dest");

  const buildingMap = maps?.[campus]?.[building];
  const startCoords = buildingMap?.[startRoom];
  const destCoords = buildingMap?.[destRoom];

  if (!buildingMap || !startCoords || !destCoords) {
    alert("Invalid campus, building, or room selection.");
  }

  let usingRearCamera = true;
  function startCamera(facingMode) {
    navigator.mediaDevices.getUserMedia({ video: { facingMode } })
      .then(stream => {
        camera.srcObject = stream;
      })
      .catch(err => {
        alert("Camera access failed: " + err.message);
      });
  }

  function flipCamera() {
    usingRearCamera = !usingRearCamera;
    const mode = usingRearCamera ? { exact: "environment" } : "user";
    startCamera(mode);
  }

  startCamera({ exact: "environment" });

  let userPosition = { x: startCoords.x, y: startCoords.y };
  let deviceHeading = 0;
  const stepLength = 0.7;
  let recentSteps = 0;

  // Improved orientation tracking
  window.addEventListener('deviceorientation', e => {
    if (e.alpha !== null) {
      deviceHeading = e.alpha;
    }
  });

  // Enhanced step detection
  let lastStepTime = 0;
  window.addEventListener('devicemotion', e => {
    const acc = e.accelerationIncludingGravity;
    const now = Date.now();

    if (acc && acc.z > 9 && now - lastStepTime > 400) {
      lastStepTime = now;
      recentSteps++;
      const rad = deviceHeading * Math.PI / 180;
      userPosition.x += Math.cos(rad) * stepLength;
      userPosition.y += Math.sin(rad) * stepLength;
      console.log("Step detected. Position:", userPosition);
    }
  });

  function getAngleToDestination(destX, destY) {
    const dx = destX - userPosition.x;
    const dy = destY - userPosition.y;
    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
    return (angle + 360) % 360;
  }

  function updateArrowRotation() {
    const bearing = getAngleToDestination(destCoords.x, destCoords.y);
    const rotation = ((bearing - deviceHeading) + 360) % 360;
    arrow.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;

    const distance = Math.sqrt(
      Math.pow(destCoords.x - userPosition.x, 2) +
      Math.pow(destCoords.y - userPosition.y, 2)
    );

    progressPrompt.textContent = `You're ${distance.toFixed(1)} units away from ${destRoom}`;

    // Enhanced proximity zone logic
    if (distance < 1.5 && recentSteps < 2 && Math.abs(rotation) < 20) {
      arrivalPrompt.style.display = 'block';
    } else {
      arrivalPrompt.style.display = 'none';
    }

    recentSteps = 0; // reset after each frame
    requestAnimationFrame(updateArrowRotation);
  }

  requestAnimationFrame(updateArrowRotation);
</script>

</body>
</html>
