<!DOCTYPE html>
<html>
<head>
  <title>AR Room Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    html, body {
      margin:0; padding:0; overflow:hidden; width:100%; height:100%; background:black; font-family:sans-serif;
    }
    video#cameraFeed {
      position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:0;
    }
    a-scene {
      position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:1; pointer-events:none;
    }
    #motionOverlay {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background: rgba(0,0,0,0.85); display:flex; justify-content:center; align-items:center; z-index:10;
    }
    #motionButton {
      font-size:2rem; padding:1rem 2rem; background-color:rgba(0,0,0,0.5); color:white;
      border:2px solid white; border-radius:8px; cursor:pointer;
    }
    #destinationPrompt, #progressPrompt, #stopGoPrompt {
      position:absolute; left:50%; transform:translateX(-50%);
      background: rgba(0,0,0,0.6); color:white; padding:8px 16px; border-radius:6px; z-index:5; text-align:center;
    }
    #destinationPrompt { top:3%; font-size:1.25rem; }
    #progressPrompt { top:18%; font-size:1.1rem; }
    #stopGoPrompt { bottom:15%; font-size:1.3rem; display:none; }
    .step-button {
      position:absolute; bottom:5%; padding:12px 20px; font-size:1.2rem; border-radius:8px; border:none; cursor:pointer; z-index:5;
    }
    #simulatePrev { left:10%; }
    #simulateNext { right:10%; }
    #findRoom { bottom:5%; left:50%; transform:translateX(-50%); display:none; }
  </style>
</head>
<body>
  <video id="cameraFeed" autoplay playsinline></video>

  <div id="motionOverlay">
    <button id="motionButton" onclick="enableMotion()">Enable Motion</button>
  </div>

  <div id="destinationPrompt">Destination: Loading...</div>
  <div id="progressPrompt">Loading navigation...</div>
  <div id="stopGoPrompt">STOP</div>

  <button id="simulatePrev" class="step-button">Simulate Steps</button>
  <button id="simulateNext" class="step-button">Simulate Next Steps</button>
  <button id="findRoom" class="step-button">Find Another Room</button>

  <a-scene id="sceneRoot" embedded visible="false" renderer="antialias:true; alpha:true"
           vr-mode-ui="enabled:false" xr-mode-ui="enabled:false" loading-screen="enabled:false"
           device-orientation-permission-ui="enabled:false">
    <a-entity id="camera" camera look-controls="touchEnabled:false">
      <a-entity id="arrow3d" geometry="primitive:cone; radiusBottom:0.15; height:0.5"
                material="color:red" position="0 -0.3 -1.5">
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const STEP_ANIM_TIME = 5000; // 5s per step animation
    const STEP_FRACTION_MIN = 5; // min steps per fraction
    const ARRIVAL_RADIUS = 1.5;

    // ==========================
    // DOM
    // ==========================
    const arrow3d = document.getElementById("arrow3d");
    const progressPrompt = document.getElementById("progressPrompt");
    const destinationPrompt = document.getElementById("destinationPrompt");
    const stopGoPrompt = document.getElementById("stopGoPrompt");
    const simulatePrevBtn = document.getElementById("simulatePrev");
    const simulateNextBtn = document.getElementById("simulateNext");
    const findRoomBtn = document.getElementById("findRoom");
    const video = document.getElementById("cameraFeed");

    // ==========================
    // LOCATION DATA (keep original)
    // ==========================
    function normalize(str){ return str?.trim(); }
    const maps = {
      MainCampus: {
        EngineeringHall: {
          Room101:{x:10,y:5}, Room102:{x:12,y:5}, Room201:{x:10,y:10}, Room202:{x:12,y:10},
          Lobby:{x:5,y:2}, Entrance:{x:0,y:0}
        },
        Library: {
          Room301:{x:8,y:3}, Room302:{x:9,y:6}, Entrance:{x:0,y:0}
        }
      },
      ArmstrongCampus: {
        ScienceCenter:{
          Room401:{x:15,y:10}, Room402:{x:17,y:12}, Entrance:{x:0,y:0}
        }
      }
    };

    const params = new URLSearchParams(window.location.search);
    const campus = normalize(params.get("campus"));
    const building = normalize(params.get("building"));
    const startRoom = normalize(params.get("start"));
    const destRoom = normalize(params.get("dest"));

    const buildingMap = maps[campus]?.[building];
    const startCoords = buildingMap?.[startRoom];
    const destCoords = buildingMap?.[destRoom];
    const destinationName = destRoom.toUpperCase();

    if(!startCoords || !destCoords){
      alert("Invalid campus, building, or room selection.");
    } else {
      destinationPrompt.textContent = "Destination: "+destinationName;
    }

    // ==========================
    // CAMERA INIT
    // ==========================
    async function initCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        video.srcObject = stream;
      } catch(err){ alert("Camera access failed: "+err.message); }
    }

    async function enableMotion(){
      const overlay = document.getElementById("motionOverlay");
      const scene = document.getElementById("sceneRoot");
      try{
        if(typeof DeviceOrientationEvent?.requestPermission==="function"){
          const perm = await DeviceOrientationEvent.requestPermission();
          if(perm!=="granted"){ alert("Motion permission denied."); return; }
        }
      } catch(e){ alert("Motion permission error: "+e); return; }
      overlay.style.display="none";
      scene.setAttribute("visible","true");
      await initCamera();
      startTracking();
    }

    // ==========================
    // NAVIGATION STATE
    // ==========================
    let currentPos = {x:startCoords.x, y:startCoords.y};
    let remainingDistance = Math.hypot(destCoords.x-startCoords.x, destCoords.y-startCoords.y);
    let stepFractions = [];
    let stepIndex = 0;
    const MAX_FRACTIONS = Math.ceil(remainingDistance/2); // farther = more fractions

    // ==========================
    // TRACKING + ARROW
    // ==========================
    function startTracking(){
      requestAnimationFrame(updateArrow);
    }

    function updateArrow(){
      if(!remainingDistance) return;
      const dx = destCoords.x - currentPos.x;
      const dy = destCoords.y - currentPos.y;
      const angle = Math.atan2(dy, dx);
      arrow3d.object3D.rotation.set(0,-angle,0);
      // Distance display
      progressPrompt.textContent = `Distance: ${remainingDistance.toFixed(1)}m`;
      requestAnimationFrame(updateArrow);
    }

    // ==========================
    // STEP ANIMATION LOGIC
    // ==========================
    function generateStepPositions(fractionDistance){
      const steps = Math.max(Math.floor(fractionDistance),STEP_FRACTION_MIN);
      const positions = [];
      for(let i=1;i<=steps;i++){
        const t = i/steps;
        const spread = (Math.random()*0.4-0.2); // slight arc
        positions.push({x:t*dxWithAngle()*Math.cos(angleWithDXDY())+spread, z:-t*dxWithAngle()*Math.sin(angleWithDXDY())});
      }
      return positions;
    }

    function dxWithAngle(){ return destCoords.x-currentPos.x; }
    function angleWithDXDY(){ return Math.atan2(destCoords.y-currentPos.y, destCoords.x-currentPos.x); }

    function animateSteps(fractionDistance){
      stopGoPrompt.style.display="block"; stopGoPrompt.textContent="STOP";
      simulatePrevBtn.disabled=true; simulateNextBtn.disabled=true;
      const positions = generateStepPositions(fractionDistance);
      const scene = document.querySelector("a-scene");

      positions.forEach(pos=>{
        const step = document.createElement("a-circle");
        step.setAttribute("position", `${pos.x} 0 ${pos.z}`);
        step.setAttribute("radius", "0.1");
        step.setAttribute("color","red");
        step.setAttribute("rotation","-90 0 0");
        scene.appendChild(step);
        setTimeout(()=>{ step.remove(); }, STEP_ANIM_TIME);
      });

      setTimeout(()=>{
        stopGoPrompt.textContent="GO";
        simulatePrevBtn.disabled=false; simulateNextBtn.disabled=false;
      }, STEP_ANIM_TIME);
    }

    // ==========================
    // BUTTON HANDLERS
    // ==========================
    simulatePrevBtn.onclick = function(){
      const dx = destCoords.x-currentPos.x;
      const dy = destCoords.y-currentPos.y;
      const dist = Math.hypot(dx,dy)/MAX_FRACTIONS;
      animateSteps(dist);
    };

    simulateNextBtn.onclick = function(){
      const dx = destCoords.x-currentPos.x;
      const dy = destCoords.y-currentPos.y;
      const dist = Math.hypot(dx,dy)/MAX_FRACTIONS;
      currentPos.x += dx/MAX_FRACTIONS;
      currentPos.y += dy/MAX_FRACTIONS;
      remainingDistance = Math.hypot(destCoords.x-currentPos.x, destCoords.y-currentPos.y);

      if(remainingDistance<=ARRIVAL_RADIUS){
        simulatePrevBtn.disabled=true;
        simulateNextBtn.disabled=true;
        findRoomBtn.style.display="block";
      }
      animateSteps(dist);
    };

    findRoomBtn.onclick=function(){ window.location.href="Select.html"; };

    requestAnimationFrame(updateArrow);
  </script>
</body>
</html>
