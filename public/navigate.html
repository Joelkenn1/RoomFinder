<!DOCTYPE html>
<html>
<head>
  <title>Indoor AR Navigation</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    #arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      transform-origin: center;
      transition: transform 0.2s ease;
      z-index: 10;
    }
    #arrivalPrompt {
      display: none;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 20;
    }
  </style>
</head>
<body>
  <video id="camera" autoplay playsinline></video>
  <img id="arrow" src="arrow.png" alt="Arrow">
  <div id="arrivalPrompt">You've arrived at your classroom!</div>

  <script>
    const arrow = document.getElementById('arrow');
    const arrivalPrompt = document.getElementById('arrivalPrompt');

    // Indoor maps by campus and building
    const maps = {
      MainCampus: {
        EngineeringHall: {
          Room101: { x: 10, y: 5 },
          Room102: { x: 12, y: 5 },
          Room201: { x: 10, y: 10 },
          Room202: { x: 12, y: 10 },
          Lobby: { x: 5, y: 2 },
          Entrance: { x: 0, y: 0 }
        },
        Library: {
          Room301: { x: 8, y: 3 },
          Room302: { x: 9, y: 6 },
          Entrance: { x: 0, y: 0 }
        }
      },
      ArmstrongCampus: {
        ScienceCenter: {
          Room401: { x: 15, y: 10 },
          Room402: { x: 17, y: 12 },
          Entrance: { x: 0, y: 0 }
        }
      }
    };

    // Parse parameters from URL
    const params = new URLSearchParams(window.location.search);
    const campus = params.get("campus");
    const building = params.get("building");
    const startRoom = params.get("start");
    const destRoom = params.get("dest");

    const buildingMap = maps?.[campus]?.[building];
    const startCoords = buildingMap?.[startRoom];
    const destCoords = buildingMap?.[destRoom];

    if (!buildingMap || !startCoords || !destCoords) {
      alert("Invalid campus, building, or room selection.");
    }

    // Start camera
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        document.getElementById('camera').srcObject = stream;
      })
      .catch(err => {
        alert("Camera access failed. Please use HTTPS and allow permissions.");
      });

    // Set initial position from start room
    let userPosition = { x: startCoords.x, y: startCoords.y };
    let deviceHeading = 0;

    // Track orientation
    window.addEventListener('deviceorientationabsolute', e => {
      if (e.absolute && e.alpha !== null) {
        deviceHeading = e.alpha;
      }
    });

    // Function to update user position manually (e.g., via QR scan or tap)
    function updateUserPosition(x, y) {
      userPosition.x = x;
      userPosition.y = y;
    }

    // Calculate angle to destination
    function getAngleToDestination(destX, destY) {
      const dx = destX - userPosition.x;
      const dy = destY - userPosition.y;
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      return (angle + 360) % 360;
    }

    // Update arrow rotation
    function updateArrowRotation() {
      const bearing = getAngleToDestination(destCoords.x, destCoords.y);
      const rotation = bearing - deviceHeading;

      arrow.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;

      // Arrival detection (within ~1 unit)
      const distance = Math.sqrt(
        Math.pow(destCoords.x - userPosition.x, 2) +
        Math.pow(destCoords.y - userPosition.y, 2)
      );
      if (distance < 1) {
        arrivalPrompt.style.display = 'block';
      } else {
        arrivalPrompt.style.display = 'none';
      }
    }

    setInterval(updateArrowRotation, 1000);
  </script>
</body>
</html>
