<!DOCTYPE html>
<html>
<head>
  <title>Indoor AR Navigation</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    #arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      transform-origin: center;
      transition: transform 0.2s ease;
      z-index: 10;
    }
    #arrivalPrompt {
      display: none;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 20;
    }
    #progressPrompt {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 16px;
      z-index: 20;
    }
    #flipButton {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 20;
      padding: 10px 15px;
      font-size: 14px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #flipButton:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <video id="camera" autoplay playsinline></video>
  <img id="arrow" src="arrow.png" alt="Arrow">
  <div id="arrivalPrompt">You've arrived at your classroom!</div>
  <div id="progressPrompt">Calculating progress...</div>
  <button id="flipButton" onclick="flipCamera()">Flip Camera</button>

  <script>
    const STEP_THRESHOLD = 2.0;
    const STEP_INTERVAL = 400;
    const STEP_LENGTH = 0.7;
    const ARRIVAL_RADIUS = 1.5;
    const ROTATION_TOLERANCE = 20;

    const arrow = document.getElementById('arrow');
    const arrivalPrompt = document.getElementById('arrivalPrompt');
    const progressPrompt = document.getElementById('progressPrompt');
    const camera = document.getElementById('camera');

    const maps = {
      MainCampus: {
        EngineeringHall: {
          Room101: { x: 10, y: 5 },
          Room102: { x: 12, y: 5 },
          Room201: { x: 10, y: 10 },
          Room202: { x: 12, y: 10 },
          Lobby: { x: 5, y: 2 },
          Entrance: { x: 0, y: 0 }
        },
        Library: {
          Room301: { x: 8, y: 3 },
          Room302: { x: 9, y: 6 },
          Entrance: { x: 0, y: 0 }
        }
      },
      ArmstrongCampus: {
        ScienceCenter: {
          Room401: { x: 15, y: 10 },
          Room402: { x: 17, y: 12 },
          Entrance: { x: 0, y: 0 }
        }
      }
    };

    function normalize(str) {
      return str?.trim();
    }

    const params = new URLSearchParams(window.location.search);
    const campus = normalize(params.get("campus"));
    const building = normalize(params.get("building"));
    const startRoom = normalize(params.get("start"));
    const destRoom = normalize(params.get("dest"));

    const buildingMap = maps?.[campus]?.[building];
    const startCoords = buildingMap?.[startRoom];
    const destCoords = buildingMap?.[destRoom];

    if (!startCoords || !destCoords) {
      alert("Invalid campus, building, or room selection.");
    }

    let usingRearCamera = true;
    function startCamera(facingMode) {
      navigator.mediaDevices.getUserMedia({ video: { facingMode } })
        .then(stream => camera.srcObject = stream)
        .catch(err => alert("Camera access failed: " + err.message));
    }

    function flipCamera() {
      usingRearCamera = !usingRearCamera;
      const mode = usingRearCamera ? { exact: "environment" } : "user";
      startCamera(mode);
    }

    startCamera({ exact: "environment" });

    let userPosition = { ...startCoords };
    let deviceHeading = 0;
    let recentSteps = 0;
    let lastStepTime = 0;

    // Request permission for motion sensors (iOS)
    function requestSensorAccess() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              console.log("Motion permission granted");
            } else {
              alert("Motion access denied");
            }
          })
          .catch(console.error);
      }
    }

    document.body.addEventListener('click', requestSensorAccess, { once: true });

    // Orientation tracking
    window.addEventListener('deviceorientation', e => {
      if (e.alpha !== null) {
        deviceHeading = e.alpha;
        console.log("Orientation:", deviceHeading);
      }
    });

    // Step detection
    window.addEventListener('devicemotion', e => {
      const acc = e.accelerationIncludingGravity;
      const now = Date.now();
      if (acc?.z > STEP_THRESHOLD && now - lastStepTime > STEP_INTERVAL) {
        lastStepTime = now;
        recentSteps++;
        const rad = deviceHeading * Math.PI / 180;
        userPosition.x += Math.cos(rad) * STEP_LENGTH;
        userPosition.y += Math.sin(rad) * STEP_LENGTH;
        console.log("Step detected. Position:", userPosition);
      }
    });

    function updateNavigation() {
      const dx = destCoords.x - userPosition.x;
      const dy = destCoords.y - userPosition.y;
      const bearing = (Math.atan2(dy, dx) * 180 / Math.PI + 360) % 360;
      const rotation = (bearing - deviceHeading + 360) % 360;

      arrow.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;

      const distance = Math.hypot(dx, dy);
      progressPrompt.textContent = `You're ${distance.toFixed(1)} units away from ${destRoom}`;
      arrivalPrompt.style.display = (distance < ARRIVAL_RADIUS && recentSteps < 2 && Math.abs(rotation) < ROTATION_TOLERANCE) ? 'block' : 'none';

      console.log("Rotation:", rotation, "Distance:", distance);
      recentSteps = 0;
      requestAnimationFrame(updateNavigation);
    }

    requestAnimationFrame(updateNavigation);
  </script>
</body>
</html>
